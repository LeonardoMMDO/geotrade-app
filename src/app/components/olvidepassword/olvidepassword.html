<div class="background-overlay">

  <!-- Botón regresar -->
  <button class="btn-regresar-fixed" style="background:none; border:none;" (click)="goBack()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="50" height="50">
      <path fill="white"
        d="M256 0C114.6 0 0 114.6 0 256c0 141.4 114.6 256 256 256s256-114.6 256-256
           C512 114.6 397.4 0 256 0zM384 288H205.3l49.38 49.38c12.5 12.5 12.5 32.75 0 45.25
           s-32.75 12.5-45.25 0L105.4 278.6c-12.5-12.5-12.5-32.75 0-45.25l104.1-104.1
           c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25L205.3 224H384
           c17.69 0 32 14.31 32 32S401.7 288 384 288z" />
    </svg>
  </button>

  <div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="crud-card shadow-lg">

      <!-- ══════════════════════════════════════
           PASO 1 — Seleccionar método
      ══════════════════════════════════════ -->
      <div class="step-content" [class.step-active]="currentStep === 1">
        <div class="text-center">
          <div class="icon-wrapper-hover">
            <svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" fill="currentColor"
              class="bi bi-lock-fill" viewBox="0 0 16 16">
              <path
                d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2" />
            </svg>
          </div>
          <h2 class="fw-bold mt-3">Restablecer Contraseña</h2><br>
          <p class="text-muted small">Selecciona el método de verificación.</p>
        </div>
<br><br>
        <div class="method-row my-4">
          <div class="method-square">
            <input type="radio" name="method" id="mail"
              [checked]="selectedMethod === 'correo'"
              (change)="selectMethod('correo')">
            <label for="mail">
              <i class="bi bi-envelope-fill"></i>
              <span class="fw-bold">Correo</span>
            </label>
          </div>
          <div class="method-square">
            <input type="radio" name="method" id="sms"
              [checked]="selectedMethod === 'sms'"
              (change)="selectMethod('sms')">
            <label for="sms">
              <i class="bi bi-chat-dots-fill"></i>
              <span class="fw-bold">SMS</span>
            </label>
          </div>
        </div>

        <button class="btn-geotrade" (click)="goToStep2()">Continuar</button>
      </div>

      <!-- ══════════════════════════════════════
           PASO 2 — Ingresar correo / teléfono
      ══════════════════════════════════════ -->
      <div class="step-content" [class.step-active]="currentStep === 2">
        <div class="text-center">
          <div class="icon-wrapper-hover mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="90" height="90" fill="currentColor" viewBox="0 0 16 16">
              <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
              <path fill-rule="evenodd"
                d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37
                   C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
            </svg>
          </div>
          <h2 class="fw-bold">{{ selectedMethod === 'correo' ? 'Ingresa tu Correo' : 'Ingresa tu Teléfono' }}</h2>
          <p class="text-muted small">
            {{ selectedMethod === 'correo' ? 'Te enviaremos un código de verificación.' : 'Te enviaremos un SMS con el código.' }}
          </p>
        </div><br>

        <div class="my-4">
          <input
            [type]="selectedMethod === 'correo' ? 'email' : 'tel'"
            class="form-control custom-input"
            [placeholder]="selectedMethod === 'correo' ? 'Correo electrónico' : 'Número de teléfono'"
            [(ngModel)]="contacto"
            (keyup.enter)="enviarCodigo()"
          />
          <div class="text-danger small mt-2 ps-2" *ngIf="contactoError">{{ contactoError }}</div>
        </div>

        <button class="btn-geotrade" (click)="enviarCodigo()" [disabled]="loading">
            <span *ngIf="!loading">Enviar Código</span>
            <span *ngIf="loading">
                <span class="spinner-border spinner-border-sm me-2"></span>Enviando...
            </span>
        </button>

        <div class="text-center mt-3">
          <span class="back-text" (click)="goBack()">Regresar</span>
        </div>
      </div>

      <!-- ══════════════════════════════════════
           PASO 3 — Código OTP
      ══════════════════════════════════════ -->
      <div class="step-content" [class.step-active]="currentStep === 3">
        <div class="text-center">
          <div class="icon-wrapper-hover mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="90" height="90" fill="currentColor" viewBox="0 0 16 16">
              <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
              <path fill-rule="evenodd"
                d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37
                   C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
            </svg>
          </div>
          <h2 class="fw-bold">Verifica tu Identidad</h2>
          <p class="text-muted small">Código enviado a <strong>{{ contacto }}</strong></p>
        </div>

        <div class="code-inputs d-flex justify-content-between my-4">
          <input *ngFor="let digit of otpDigits; let i = index"
            [id]="'otp-' + i"
            type="text"
            inputmode="numeric"
            maxlength="1"
            placeholder="-"
            [value]="otpDigits[i]"
            (input)="onOtpInput(i, $event)"
            (keydown)="onOtpKeydown(i, $event)"
            (paste)="onOtpPaste($event)"
          />
        </div>

        <div class="text-danger small text-center mb-2" *ngIf="otpError">{{ otpError }}</div>

        <div class="text-center mb-4">
          <p class="small text-muted">¿No recibiste el código?<br>
            <span
              class="text-success fw-bold text-decoration-none"
              [style.cursor]="resendSeconds > 0 ? 'default' : 'pointer'"
              [style.opacity]="resendSeconds > 0 ? '0.55' : '1'"
              (click)="reenviarCodigo()">
              Reenviar {{ resendSeconds > 0 ? '(' + resendSeconds + 's)' : '' }}
            </span>
          </p>
        </div>

        <button class="btn-geotrade" (click)="verificarCodigo()">Continuar</button>

        <div class="text-center mt-3">
          <span class="back-text" (click)="goBack()">Regresar</span>
        </div>
      </div>

      <!-- ══════════════════════════════════════
           PASO 4 — Nueva contraseña
      ══════════════════════════════════════ -->
      <div class="step-content" [class.step-active]="currentStep === 4">
        <div class="text-center">
          <div class="icon-wrapper-hover mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" fill="currentColor"
              class="bi bi-lock-fill" viewBox="0 0 16 16">
              <path
                d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2" />
            </svg>
          </div>
          <h2 class="fw-bold mt-2">Nueva Contraseña</h2>
          <p class="text-muted small">Elige una contraseña segura.</p>
        </div>

        <!-- Barra de fortaleza -->
        <div class="my-3" *ngIf="nuevaPassword">
          <div class="strength-bar-bg">
            <div class="strength-bar-fill"
              [style.width]="strengthWidth"
              [style.background]="passwordStrength.color">
            </div>
          </div>
          <small [style.color]="passwordStrength.color" class="fw-bold">{{ passwordStrength.label }}</small>
        </div>

        <!-- Nueva contraseña -->
        <div class="input-eye-wrapper mb-3" [class.mt-4]="!nuevaPassword">
          <input
            [type]="showNueva ? 'text' : 'password'"
            class="form-control custom-input"
            placeholder="Nueva Contraseña"
            [(ngModel)]="nuevaPassword"
          />
          <span class="eye-toggle" (click)="showNueva = !showNueva">
            <i class="bi" [ngClass]="showNueva ? 'bi-eye-slash' : 'bi-eye'"></i>
          </span>
        </div>

        <!-- Confirmar contraseña -->
        <div class="input-eye-wrapper mb-3">
          <input
            [type]="showConfirmar ? 'text' : 'password'"
            class="form-control custom-input"
            placeholder="Confirmar Contraseña"
            [(ngModel)]="confirmarPassword"
          />
          <span class="eye-toggle" (click)="showConfirmar = !showConfirmar">
            <i class="bi" [ngClass]="showConfirmar ? 'bi-eye-slash' : 'bi-eye'"></i>
          </span>
        </div>

        <div class="text-danger small mb-2 ps-2" *ngIf="passwordError">{{ passwordError }}</div>

        <button class="btn-geotrade" (click)="actualizarPassword()" [disabled]="loading">
          <span *ngIf="!loading">Actualizar Contraseña</span>
          <span *ngIf="loading"><span class="spinner-border spinner-border-sm me-2"></span>Actualizando...</span>
        </button>

        <div class="text-center mt-3">
          <span class="back-text" (click)="goBack()">Regresar</span>
        </div>
      </div>

      <!-- ══════════════════════════════════════
           PASO 5 — Éxito
      ══════════════════════════════════════ -->
      <div class="step-content text-center" [class.step-active]="currentStep === 5">
        <div class="icon-wrapper-hover mb-3">
          <i class="bi bi-check-circle-fill" style="font-size: 4.5rem; color: #7DA400;"></i>
        </div>
        <h2 class="fw-bold mt-2">¡Contraseña Actualizada!</h2>
        <p class="text-muted small mb-4">
          Tu contraseña ha sido cambiada exitosamente.<br>
          Ya puedes iniciar sesión con tu nueva clave.
        </p>
        <button class="btn-geotrade" (click)="irALogin()">Ir al Login</button>
      </div>

    </div>
  </div>
</div>